.DEFAULT_GOAL := all

CLUSTER_API_PROVIDER_VERSION_FILE=cluster-api.version
CLUSTER_API_PROVIDER_VERSION=$(file < $(CLUSTER_API_PROVIDER_VERSION_FILE))

CLUSTERCTL=bin/clusterctl
$(CLUSTERCTL):
	mkdir -p $(dir $(CLUSTERCTL))
	curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/$(CLUSTER_API_PROVIDER_VERSION)/clusterctl-$(shell uname | tr '[A-Z]' '[a-z]')-amd64 -o $(CLUSTERCTL)
	chmod +x $(CLUSTERCTL)

CORE_MANIFESTS=core.yaml
$(CORE_MANIFESTS): $(CLUSTERCTL) $(CLUSTER_API_PROVIDER_VERSION_FILE) Makefile
	$(CLUSTERCTL) generate provider \
		--core cluster-api:$(CLUSTER_API_PROVIDER_VERSION) > $(CORE_MANIFESTS) \
	|| rm $(CORE_MANIFESTS)

BOOTSTRAP_MANIFESTS=bootstrap.yaml
$(BOOTSTRAP_MANIFESTS): $(CLUSTERCTL) $(CLUSTER_API_PROVIDER_VERSION_FILE) Makefile
	$(CLUSTERCTL) generate provider \
		--bootstrap kubeadm:$(CLUSTER_API_PROVIDER_VERSION) > $(BOOTSTRAP_MANIFESTS) \
	|| rm $(BOOTSTRAP_MANIFESTS)

CONTROL_PLANE_MANIFESTS=control-plane.yaml
$(CONTROL_PLANE_MANIFESTS): $(CLUSTERCTL) $(CLUSTER_API_PROVIDER_VERSION_FILE) Makefile
	$(CLUSTERCTL) generate provider \
		--control-plane kubeadm:$(CLUSTER_API_PROVIDER_VERSION) > $(CONTROL_PLANE_MANIFESTS) \
	|| rm $(CONTROL_PLANE_MANIFESTS)

METAL3_PROVIDER_VERSION_FILE=metal3-provider.version
METAL3_PROVIDER_VERSION=$(file < $(METAL3_PROVIDER_VERSION_FILE))
INFRASTRUCTURE_MANIFESTS=infrastructure.yaml
$(INFRASTRUCTURE_MANIFESTS): $(CLUSTERCTL) $(METAL3_PROVIDER_VERSION_FILE) Makefile
	CAPM3_FAST_TRACK="'true'" $(CLUSTERCTL) generate provider \
		--infrastructure metal3:$(METAL3_PROVIDER_VERSION) > $(INFRASTRUCTURE_MANIFESTS) \
	|| rm $(INFRASTRUCTURE_MANIFESTS)

PHONY: all
all: $(CORE_MANIFESTS) $(BOOTSTRAP_MANIFESTS) $(CONTROL_PLANE_MANIFESTS) $(INFRASTRUCTURE_MANIFESTS)
